syntax = "proto3";

package workitem.v1;

// Service Definition
service WorkItemService {
  // Create a new WorkItem
  rpc CreateWorkItem (CreateWorkItemRequest) returns (WorkItemResponse);

  // Claim a WorkItem (assign to user)
  rpc ClaimWorkItem (ClaimWorkItemRequest) returns (WorkItemResponse);

  // Complete a WorkItem (success)
  rpc CompleteWorkItem (CompleteWorkItemRequest) returns (WorkItemResponse);

  // Cancel a WorkItem (failure/abort)
  rpc CancelWorkItem (CancelWorkItemRequest) returns (WorkItemResponse);

  // Get WorkItem details
  rpc GetWorkItem (GetWorkItemRequest) returns (WorkItemDetailsResponse);
}

// ------------------------------------------------------------
// Common Types
// ------------------------------------------------------------

message CommandContext {
  string actor_id = 1;
  string tenant_id = 2; // Optional, for context
  string idempotency_key = 3; // For idempotent retries
}

message WorkItemResponse {
  bool accepted = 1;
  string message = 2; // Error message if not accepted
  int32 work_item_id = 3;
  string state = 4;
}

// ------------------------------------------------------------
// Requests
// ------------------------------------------------------------

message Parameter {
  string name = 1;
  string direction = 2;  // 'IN' | 'OUT' | 'INOUT'
  bool mandatory = 3;
  string value_json = 4;  // JSON stringified value
}

message AssignmentSpec {
  repeated string candidate_users = 1;
  repeated string candidate_groups = 2;
  repeated string candidate_positions = 3;
  repeated string candidate_org_units = 4;
  string strategy = 5;
  string mode = 6;  // 'PULL' | 'PUSH'
  string separation_of_duties_key = 7;
}

message CreateWorkItemRequest {
  // Core identification
  string workflow_id = 1;
  string run_id = 2;
  string task_type = 3;
  string task_name = 4;
  
  // Optional metadata
  string description = 5;
  int32 priority = 6;
  
  // Assignment specification
  AssignmentSpec assignment_spec = 7;
  
  // Lifecycle and actor info
  string lifecycle = 8;
  string initiated_by = 9;
  string initiated_at = 10;  // ISO 8601 timestamp
  
  // Parameters as structured array
  repeated Parameter parameters = 11;
  
  // Context data as JSON string
  string context_data = 12;
  
  // Optional deadline
  string due_date = 13;  // ISO 8601 timestamp
  
  // Distribution config (for backward compatibility)
  string distribution_strategy = 14;
  string distribution_mode = 15;
  
  // Context
  CommandContext context = 16;
}

message ClaimWorkItemRequest {
  int32 work_item_id = 1;
  CommandContext context = 2;
}

message CompleteWorkItemRequest {
  int32 work_item_id = 1;
  string output_json = 2; // JSON stringified output
  CommandContext context = 3;
}

message CancelWorkItemRequest {
  int32 work_item_id = 1;
  string reason = 2;
  CommandContext context = 3;
}

message GetWorkItemRequest {
  int32 work_item_id = 1;
}

message WorkItemDetailsResponse {
  bool found = 1;
  int32 work_item_id = 2;
  string workflow_id = 3;
  string task_name = 4;
  string state = 5;
  string created_at = 6;
  string assigned_to = 7; // User ID if assigned
  repeated string offered_to = 8; // List of users offered to
  string parameters_json = 9;
  string output_json = 10;
}
